<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">
    var personaId = "63ce2034-8a40-4c9e-b83d-2735c7206bd0"; // Chronopolize
    var matchesToGet = 400; // should be multiple of 100


    requestMatchData();

    function requestMatchData() {
        var numberOfBatches = matchesToGet / 100;

        //load requests
        var requests = []
        for (var i = 0; i < numberOfBatches; i++) {
            offset = i * 100;
            var reqURL = "https://ashesescalation-api-tachyon.stardock.net/v1/products/2641/matches?personaid=" + personaId + "&offset=" + offset + "&count=100"

            requests.push($.ajax({
                    url: reqURL,
                    delay: 1000 * i,
                    type: "GET",
                    success: function(data) {
                        processData(data);
                    },
                    dataType: "json",
                    error: function() {
                        console.log("Request to Ashes API failed")
                    }
                }));
            }


            $.when.apply(null, requests).done(function() {
                console.log("All done!");
                computeStats();
                printResults();
            });



        }



        var playerName;
        var results = {};
        var rankedGameCount = 0;
        var rankedWins = 0;
        var rankedWinPercent;

        function processData(data) {

            console.log("Recieved a response");

            // Process the match data
            for (var i = 0; i < data.length; i++) {
                var match = data[i];
                //Determine the result of the match.
                if (match.dataString.type == "1v1Ranked") {
                    var player, opponent;
                    if (match.participants[0].personaId == personaId) {
                        player = match.participants[0];
                        opponent = match.participants[1];
                    } else {
                        player = match.participants[1];
                        opponent = match.participants[0];
                    }

                    var isVictory = player.dataInteger.result == 1 ? true : false;
                    var opponentName = opponent.name;
                    playerName = player.name; //lazy way of getting the player's name.

                    // console.log("Game result: " + isVictory + " vs" + opponentName);

                    // Update results:

                    if (results[opponentName] == null) {
                        results[opponentName] = {
                            wins: 0,
                            losses: 0,
                            numGames: 0
                        }
                    }
                    if (isVictory) {
                        rankedWins += 1;
                        results[opponentName].wins += 1;
                    } else {
                        results[opponentName].losses += 1;
                    }
                    rankedGameCount += 1;
                    results[opponentName].numGames += 1;
                }


            }
        }

        function computeStats() {
            // Calculate relevant stats:
            for (var opponent in results) {
                if (results.hasOwnProperty(opponent)) {
                    var record = results[opponent];
                    record.winPercent = Math.round(1.0 * record.wins / record.numGames * 100);
                }
            }
            rankedWinPercent = Math.round(1.0 * rankedWins / rankedGameCount * 100)
        }

        function printResults() {
            console.log("---");
            console.log("Player name: " + playerName);

            console.log ("From last " + rankedGameCount + " ranked games, Win rate: " + rankedWinPercent + "%")
            for (var opponent in results) {
                if (results.hasOwnProperty(opponent)) {
                    var record = results[opponent];
                    console.log("vs " + opponent + ": " + record.wins + "W " + record.losses + "L " + record.winPercent + "%")
                }
            }
        }
    </script>
</head>

<body>
</body>